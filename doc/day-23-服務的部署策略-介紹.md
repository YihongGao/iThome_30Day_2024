# Day-23 æœå‹™çš„éƒ¨ç½²ç­–ç•¥ - ä»‹ç´¹

# å‰è¨€
åœ¨è»Ÿé«”é–‹ç™¼ä¸­ï¼Œ**å”¯ä¸€ä¸è®Šçš„å°±æ˜¯æ”¹è®Š**ï¼Œå¦‚ä½•åœ¨è»Ÿé«”æ›´æ–°è¿­ä»£ä¸­é™ä½æœå‹™ä¸­æ–·çš„é¢¨éšªï¼Œæ˜¯ä¸€å€‹é‡è¦çš„èª²é¡Œã€‚

æ¥ä¸‹ä¾†å¹¾å¤©æœƒä»‹ç´¹ æœå‹™çš„éƒ¨ç½²ç­–ç•¥ï¼Œä¸¦é€é Nginxã€Argo Rolloutsã€Flipt ç­‰å·¥å…·ä¾†å¯¦ç¾ã€‚
é¦–å…ˆï¼Œè®“æˆ‘å€‘äº†è§£å¹¾ç¨®å¸¸è¦‹çš„éƒ¨ç½²ç­–ç•¥
- é‡å»ºéƒ¨ç½²ï¼ˆRecreateï¼‰
- æ»¾å‹•éƒ¨ç½²ï¼ˆRolling Updateï¼‰
- è—ç¶ éƒ¨ç½²ï¼ˆBlue/Greenï¼‰
- é‡‘çµ²é›€éƒ¨ç½²ï¼ˆCanaryï¼‰

> ä»¥ä¸‹ä»‹ç´¹æœƒå°‡èˆŠç‰ˆæœ¬çš„æœå‹™ç¨±ç‚º **ç‰ˆæœ¬V1**ï¼Œè€Œæ–°ç‰ˆæœ¬çš„æœå‹™ç¨±ç‚º **ç‰ˆæœ¬V2** 

# é‡å»ºéƒ¨ç½²ï¼ˆRecreateï¼‰
æ­¤ç­–ç•¥æœƒå…ˆé—œé–‰ **ç‰ˆæœ¬V1** çš„æœå‹™ï¼Œå†å•Ÿå‹• **ç‰ˆæœ¬V2**ï¼Œæ•…æœƒç”¢ç”Ÿæœå‹™ä¸­æ–·ã€‚ä¸­æ–·æ™‚é–“é•·çŸ­å–æ±ºæ–¼ **ç‰ˆæœ¬V1** é—œé–‰åˆ° **ç‰ˆæœ¬V2** å•Ÿå‹•ä¹‹é–“æ‰€èŠ±è²»çš„æ™‚é–“ã€‚
![https://storage.googleapis.com/cdn.thenewstack.io/media/2017/11/c42fa239-recreate.gif](https://storage.googleapis.com/cdn.thenewstack.io/media/2017/11/c42fa239-recreate.gif)
åœ–æª”ä¾†è‡ª: [Six Strategies for Application Deployment](https://thenewstack.io/deployment-strategies/)

é¡¯è€Œæ˜“è¦‹ï¼Œé€™ç¨®æ–¹å¼ä¸é©åˆ Web æˆ– API é¡æœå‹™ï¼Œå› ç‚ºå®ƒæœƒåš´é‡å½±éŸ¿æœå‹™å¯ç”¨æ€§ã€‚ç„¶è€Œï¼Œå°æ–¼æ’ç¨‹é¡æœå‹™ä¾†èªªï¼Œé€™ç¨®ç­–ç•¥éå¸¸åˆé©ï¼Œå› ç‚ºæ’ç¨‹ä»»å‹™é€šå¸¸ä¸å¸Œæœ›å¤šå€‹ Pod å¯¦ä¾‹åŒæ™‚é‹è¡Œï¼Œä»¥é¿å…ç«¶çˆ­æ¢ä»¶ï¼ˆrace conditionï¼‰ã€‚

èƒ½é€éè¨­å®š Kubernetres Deployment çš„ `.spec.strategy.type==Recreate` å±¬æ€§ä¾†ä½¿ç”¨æ­¤ç­–ç•¥ã€‚

# æ»¾å‹•éƒ¨ç½²ï¼ˆRolling Updateï¼‰
æ»¾å‹•éƒ¨ç½²é€æ­¥åˆ‡æ›æµé‡åˆ°æ–°ç‰ˆæœ¬æœå‹™ä¸Šç•¶ **ç‰ˆæœ¬V2** çš„ Instance å»ºç«‹å¥½ä¸¦æº–å‚™å¥½æ¥æ”¶æµé‡æ™‚ï¼Œæœƒå°‡éƒ¨åˆ†æµé‡è½‰å°è‡³ **ç‰ˆæœ¬V2** çš„ Instanceï¼Œç„¶å¾Œæ‰é—œé–‰ **ç‰ˆæœ¬V1**ï¼Œé€™å€‹éç¨‹æœƒåè¦†åŸ·è¡Œç›´åˆ° **ç‰ˆæœ¬V2** å–ä»£äº† **ç‰ˆæœ¬V1** å…¨éƒ¨çš„ Instanceã€‚
![https://storage.googleapis.com/cdn.thenewstack.io/media/2017/11/5bddc931-ramped.gif](https://storage.googleapis.com/cdn.thenewstack.io/media/2017/11/5bddc931-ramped.gif)
åœ–æª”ä¾†è‡ª: [Six Strategies for Application Deployment](https://thenewstack.io/deployment-strategies/)


é€™ç¨®æ–¹å¼å¯ä»¥åœ¨ä¸å½±éŸ¿æœå‹™çš„æƒ…æ³ä¸‹é€²è¡Œæ›´æ–°ã€‚Kubernetes Deployment çš„é»˜èªéƒ¨ç½²ç­–ç•¥å°±æ˜¯æ»¾å‹•æ›´æ–°ï¼Œä¸¦ä¸”å¯ä»¥æ ¹æ“šæœå‹™éœ€æ±‚ä¾†èª¿æ•´æ›´æ–°æ•ˆç‡ã€‚

ä¹Ÿèƒ½é€éè¨­å®š Kubernetres Deployment çš„ `.spec.strategy.type==RollingUpdate` é¡¯æ€§æŒ‡å®šæ­¤ç­–ç•¥ ä¸¦ æ­é…ä»¥ä¸‹å±¬æ€§æ§åˆ¶æ›´æ–°æ•ˆç‡
- **maxUnavailable**ï¼šæ›´æ–°éç¨‹ä¸­å…è¨±å¤šå°‘å€‹ Pod æ˜¯ä¸å¯ç”¨çš„ï¼Œå¯ä»¥è¨­ç½®ç‚ºçµ•å°æ•¸å­—æˆ–ç™¾åˆ†æ¯”ã€‚
- **maxSurge**ï¼šæ›´æ–°éç¨‹ä¸­å…è¨±è¶…éæ‰€éœ€å‰¯æœ¬æ•¸çš„é¡å¤– Podï¼Œé€™å¯ä»¥åŠ é€Ÿæ›´æ–°ï¼Œå€¼å¯ä»¥æ˜¯çµ•å°æ•¸å­—æˆ–ç™¾åˆ†æ¯”ã€‚

ä½† **Rolling Update** ä»æœ‰ä»¥ä¸‹é™åˆ¶ï¼š
- **æ›´æ–°æ™‚é–“è¼ƒé•·**ï¼š é€æ­¥æ›¿æ› Pod æœƒå»¶é•·æ›´æ–°æ™‚é–“ï¼Œç‰¹åˆ¥æ˜¯å°å¤§å‹æ‡‰ç”¨ç¨‹åºã€‚
- **æ–°èˆŠç‰ˆæœ¬æ··åˆ**ï¼š æ›´æ–°æœŸé–“ï¼Œæ–°èˆŠç‰ˆæœ¬åŒæ™‚å­˜åœ¨ï¼Œå¯èƒ½å°è‡´ç”¨æˆ¶é«”é©—ä¸ä¸€è‡´ï¼Œå°¤å…¶åœ¨ç‰ˆæœ¬ä¸å…¼å®¹æ™‚ã€‚
- **ç„¡æ³•ç²¾ç¢ºæ§åˆ¶æµé‡**ï¼šé›£ä»¥åœ¨æ›´æ–°å‰é©—è­‰æ–°ç‰ˆæœ¬æœå‹™æ˜¯å¦æ­£å¸¸ã€‚

# è—ç¶ éƒ¨ç½²ï¼ˆBlue/Greenï¼‰
è—ç¶ éƒ¨ç½²çš„åŸç†æ˜¯åœ¨ä¸å½±éŸ¿ç¾æœ‰æœå‹™çš„æƒ…æ³ä¸‹ï¼Œå…ˆå°‡ **ç‰ˆæœ¬V2** å®Œæ•´éƒ¨ç½²ä¸¦é©—è­‰æœå‹™æ­£å¸¸å¾Œï¼Œå†ä¸€æ¬¡å°‡æµé‡å¾ **ç‰ˆæœ¬V1** åˆ‡æ›è‡³ **ç‰ˆæœ¬V2**ã€‚
![https://storage.googleapis.com/cdn.thenewstack.io/media/2017/11/73a2824d-blue-green.gif](https://storage.googleapis.com/cdn.thenewstack.io/media/2017/11/73a2824d-blue-green.gif)
åœ–æª”ä¾†è‡ª: [Six Strategies for Application Deployment](https://thenewstack.io/deployment-strategies/)

é€™å€‹æ–¹å¼è§£æ±ºäº†**Rolling Update**çš„é™åˆ¶ï¼Œèƒ½å³æ™‚çš„åˆ‡æ›æœå‹™ç‰ˆæœ¬ï¼Œé¿å…äº†ç‰ˆæœ¬æ··åˆå•é¡Œï¼Œä¸¦ä¸”ç•¶ **ç‰ˆæœ¬V2** éƒ¨ç½²å®Œæˆå¾Œï¼Œèƒ½é€éå…§éƒ¨æ¸¬è©¦çš„æ–¹å¼æå‰é©—è­‰æ–°ç‰ˆæœ¬æ˜¯å¦ç¬¦åˆè¦æ±‚ã€‚

è€Œè—ç¶ éƒ¨ç½²çš„ä»£åƒ¹æ˜¯å¿…é ˆèŠ±è²»é›™å€çš„ç³»çµ±è³‡æºï¼Œå› ç‚ºå¿…é ˆåŒæ™‚é‹è¡Œæ–°èˆŠç‰ˆæœ¬çš„æœå‹™ã€‚
> ğŸ“˜ Kubernetes workload åŸç”Ÿæœªæä¾›æ­¤éƒ¨ç½²ç­–ç•¥ï¼Œéœ€è¦æ­é…å…¶ä»–è§£æ±ºæ–¹æ¡ˆã€‚

# é‡‘çµ²é›€éƒ¨ç½²ï¼ˆCanaryï¼‰
é‡‘çµ²é›€éƒ¨ç½²æ˜¯ä¸€ç¨®é€æ­¥åˆ‡æ›æµé‡çš„ç­–ç•¥ï¼Œé€šå¸¸æœƒå°‡ä¸€éƒ¨åˆ†ï¼ˆä¾‹å¦‚ 10%ï¼‰çš„æµé‡è½‰ç§»åˆ° **ç‰ˆæœ¬V2**ï¼Œå…¶é¤˜æµé‡ä»ç„¶ç™¼é€åˆ° **ç‰ˆæœ¬V1**ã€‚æ ¹æ“š**ç‰ˆæœ¬V2** çš„é‹è¡Œæƒ…æ³ï¼Œé€æ­¥å¢åŠ æµé‡ï¼Œç›´åˆ°å®Œå…¨æ›¿æ› **ç‰ˆæœ¬V1**ã€‚

![https://storage.googleapis.com/cdn.thenewstack.io/media/2017/11/a6324354-canary.gif](https://storage.googleapis.com/cdn.thenewstack.io/media/2017/11/a6324354-canary.gif)
åœ–æª”ä¾†è‡ª: [Six Strategies for Application Deployment](https://thenewstack.io/deployment-strategies/)

é€™å€‹ç­–ç•¥å†ç³»çµ±é€²è¡Œé«˜é¢¨éšªè®Šæ›´ä¸”å°æ¸¬è©¦æ¶µè“‹ç‡ç¼ºä¹ä¿¡å¿ƒç‰¹åˆ¥å¥½ç”¨ï¼Œå®ƒå…è¨±é‹ç¶­åœ˜éšŠé€æ­¥è§€å¯Ÿæ–°ç‰ˆæœ¬çš„é‹è¡Œç‹€æ³ï¼Œä¸¦åœ¨ç™¼ç¾å•é¡Œæ™‚å¿«é€Ÿå›æ»¾ã€‚    
> ä½ æ°¸é ä¸çŸ¥é“å°¤å…¶ Legacy ç³»çµ±å¹«ä½ æº–å‚™äº†ä»€éº¼é©šå–œã€‚

![https://miro.medium.com/v2/resize:fit:1400/format:webp/1*tkXnZVtffjwzPC9zWNFBAg.jpeg](https://miro.medium.com/v2/resize:fit:1400/format:webp/1*tkXnZVtffjwzPC9zWNFBAg.jpeg)
åœ–æª”ä¾†è‡ª: [Bug Smashingâ€Šâ€”â€ŠA Guide To Debug Your App](https://medium.com/mindorks/bug-smashing-a-guide-to-debug-your-app-11278d832e13)
> ğŸ“˜ Kubernetes workload åŸç”Ÿæœªæä¾›æ­¤éƒ¨ç½²ç­–ç•¥ï¼Œéœ€è¦æ­é…å…¶ä»–è§£æ±ºæ–¹æ¡ˆã€‚

# å°çµ
æœ¬æ–‡ä»‹ç´¹äº†å››ç¨®å¸¸è¦‹çš„æœå‹™éƒ¨ç½²ç­–ç•¥ï¼šé‡å»ºéƒ¨ç½²ï¼ˆRecreateï¼‰ã€æ»¾å‹•éƒ¨ç½²ï¼ˆRolling Updateï¼‰ã€è—ç¶ éƒ¨ç½²ï¼ˆBlue/Greenï¼‰ã€ä»¥åŠé‡‘çµ²é›€éƒ¨ç½²ï¼ˆCanaryï¼‰ã€‚æ¯ç¨®ç­–ç•¥éƒ½æœ‰å…¶é©ç”¨å ´æ™¯èˆ‡å„ªç¼ºé»ã€‚

- **é‡å»ºéƒ¨ç½²ï¼ˆRecreateï¼‰**ï¼šç°¡å–®ç›´æ¥ï¼Œä½†æœƒç”¢ç”Ÿæœå‹™ä¸­æ–·ï¼Œä¸é©åˆéœ€è¦æŒçºŒå¯ç”¨çš„æœå‹™ã€‚
- **æ»¾å‹•éƒ¨ç½²ï¼ˆRolling Updateï¼‰**ï¼šé€éé€æ­¥æ›¿æ›ä¾†å¯¦ç¾ç„¡ä¸­æ–·æ›´æ–°ï¼Œä½†å¯èƒ½æœƒé‡åˆ°æ–°èˆŠç‰ˆæœ¬æ··åˆçš„å•é¡Œã€‚
- **è—ç¶ éƒ¨ç½²ï¼ˆBlue/Greenï¼‰**ï¼šå¯å³æ™‚åˆ‡æ›æ–°èˆŠç‰ˆæœ¬ï¼Œé¿å…ç‰ˆæœ¬æ··åˆï¼Œä½†éœ€è¦é›™å€è³‡æºä¾†é‹è¡Œã€‚
- **é‡‘çµ²é›€éƒ¨ç½²ï¼ˆCanaryï¼‰**ï¼šé€æ­¥è½‰ç§»éƒ¨åˆ†æµé‡åˆ°æ–°ç‰ˆæœ¬ï¼Œé©åˆé«˜é¢¨éšªæ›´æ–°ï¼Œä½†éœ€è¦é€²ä¸€æ­¥çš„æµé‡æ§åˆ¶å·¥å…·ã€‚

æ˜å¤©æˆ‘å€‘æœƒé€é **Nginx Ingress Controller** ä¾†å¯¦ç¾ Kubernetes åŸç”Ÿæ”¯æ´çš„å…©å€‹éƒ¨ç½²ç­–ç•¥ï¼šè—ç¶ éƒ¨ç½²ï¼ˆBlue/Greenï¼‰ã€ä»¥åŠé‡‘çµ²é›€éƒ¨ç½²ï¼ˆCanaryï¼‰ã€‚

# Refernce
- [Six Strategies for Application Deployment](https://thenewstack.io/deployment-strategies/)
- [Bug Smashingâ€Šâ€”â€ŠA Guide To Debug Your App](https://medium.com/mindorks/bug-smashing-a-guide-to-debug-your-app-11278d832e13)
